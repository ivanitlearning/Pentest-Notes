# SMB

## Check Samba version

Samba can run on either 139, 445 or both. Check its version with this

```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
sleep 0.5 && echo ""
```

Usage

```text
root@kali:~/CTF/Box# ./smbver.sh 10.1.1.15 139
```

With wireshark you can see

```text
...D DBDACODBDBCODBCODBDBDFCACACACACA. EJEOEEEJFDEIEFEMEMCNEMEBECCACAAA........T.SMBr.....C......................1..NT LANMAN 1.0..NT LM 0.12..SMB 2.002..SMB 2.???....U.SMBr...............................2....A.......-.........W.m..L....U6..(:..MYGROUP....J.SMBs.....C@..............).....
........)..-..........P...
...Unix.Samba....C.SMBs.....................).d............Unix.Samba 2.2.7a.MYGROUP....E.SMBu.....C@..............).d...............\\10.11.1.115\IPC$.?????....1.SMBu.....................).d............IPC.IPC....\.SMB......C@..............).d....................................................
```

## Null/guest shares

CME fingerprint if 445 open

```text
root@kali:~/CTF/HTB/Nest# crackmapexec smb 10.10.10.178
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
```

smbclient

```text
root@kali:~/CTF/HTB/Nest/shares# smbclient -N -L \\\\10.10.10.178

        Sharename       Type      Comment
        ---------       ----      -------
        ADMIN$          Disk      Remote Admin
        C$              Disk      Default share
        Data            Disk
        IPC$            IPC       Remote IPC
        Secure$         Disk
        Users           Disk
```

smbmap

```text
root@kali:~/CTF/HTB/Nest# smbmap -u anonymous -d HTB-NEST -H 10.10.10.178
[+] Finding open SMB ports....
[+] Guest SMB session established on 10.10.10.178...
[+] IP: 10.10.10.178:445        Name: 10.10.10.178
        Disk                                                    Permissions     Comment
        ----                                                    -----------     -------
        ADMIN$                                                  NO ACCESS       Remote Admin
        C$                                                      NO ACCESS       Default share
        .
        dr--r--r--                0 Thu Aug  8 06:53:46 2019    .
        dr--r--r--                0 Thu Aug  8 06:53:46 2019    ..
        dr--r--r--                0 Thu Aug  8 06:58:07 2019    IT
        dr--r--r--                0 Tue Aug  6 05:53:41 2019    Production
        dr--r--r--                0 Tue Aug  6 05:53:50 2019    Reports
        dr--r--r--                0 Thu Aug  8 03:07:51 2019    Shared
        Data                                                    READ ONLY
        IPC$                                                    NO ACCESS       Remote IPC
        Secure$                                                 NO ACCESS
        .
        dr--r--r--                0 Sun Jan 26 07:04:21 2020    .
        dr--r--r--                0 Sun Jan 26 07:04:21 2020    ..
        dr--r--r--                0 Fri Aug  9 23:08:23 2019    Administrator
        dr--r--r--                0 Sun Jan 26 15:21:44 2020    C.Smith
        dr--r--r--                0 Fri Aug  9 01:03:29 2019    L.Frost
        dr--r--r--                0 Fri Aug  9 01:02:56 2019    R.Thompson
        dr--r--r--                0 Thu Aug  8 06:56:02 2019    TempUser
        Users                                                   READ ONLY
```

smbmap search for files

```shell
smbmap -R <folder name> -H <target> -A Groups.xml -q
```

### With creds

CME

```text
root@kali:~/CTF/HTB/Nest# crackmapexec smb -u TempUser -p welcome2019 -d HTB-NEST 10.10.10.178
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
SMB         10.10.10.178    445    HTB-NEST         [+] HTB-NEST\TempUser:welcome2019

root@kali:~/CTF/HTB/Nest# crackmapexec smb -u TempUser -p welcome2019 -d HTB-NEST --shares 10.10.10.178
SMB         10.10.10.178    445    HTB-NEST         [*] Windows 6.1 Build 7601 (name:HTB-NEST) (domain:HTB-NEST) (signing:False) (SMBv1:False)
SMB         10.10.10.178    445    HTB-NEST         [+] HTB-NEST\TempUser:welcome2019
SMB         10.10.10.178    445    HTB-NEST         [+] Enumerated shares
SMB         10.10.10.178    445    HTB-NEST         Share           Permissions     Remark
SMB         10.10.10.178    445    HTB-NEST         -----           -----------     ------
SMB         10.10.10.178    445    HTB-NEST         ADMIN$                          Remote Admin
SMB         10.10.10.178    445    HTB-NEST         C$                              Default share
SMB         10.10.10.178    445    HTB-NEST         Data            READ
SMB         10.10.10.178    445    HTB-NEST         IPC$                            Remote IPC
SMB         10.10.10.178    445    HTB-NEST         Secure$         READ
SMB         10.10.10.178    445    HTB-NEST         Users           READ
```

smbclient

```text
root@kali:~/CTF/HTB/Nest/shares/Data# smbclient -U TempUser%welcome2019 \\\\10.10.10.178\\Data
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Aug  8 06:53:46 2019
  ..                                  D        0  Thu Aug  8 06:53:46 2019
  IT                                  D        0  Thu Aug  8 06:58:07 2019
  Production                          D        0  Tue Aug  6 05:53:38 2019
  Reports                             D        0  Tue Aug  6 05:53:44 2019
  Shared                              D        0  Thu Aug  8 03:07:51 2019

                10485247 blocks of size 4096. 6545808 blocks available
smb: \>
```

mount and show dir with `tree`

```text
root@kali:~/CTF/HTB/Nest# mount -t cifs //10.10.10.178/Data -o username=TempUser,password=welcome2019,domain=HTB-NEST /mnt/Nest/Data
root@kali:~/CTF/HTB/Nest# tree --du -h /mnt/Nest/Data
/mnt/Nest/Data
```

If the service is old enough you might need to specify the version

```text
root@kali:~/CTF# mount -t cifs -o vers=1.0 //10.11.1.136/Share /mnt/Share
🔐 Password for root@//10.11.1.136/Share:
root@kali:~/CTF# df -h
Filesystem                 Size  Used Avail Use% Mounted on
udev                       2.4G     0  2.4G   0% /dev
tmpfs                      480M  1.5M  479M   1% /run
/dev/mapper/kali--vg-root   54G   24G   28G  47% /
tmpfs                      2.4G     0  2.4G   0% /dev/shm
tmpfs                      5.0M     0  5.0M   0% /run/lock
tmpfs                      4.0M     0  4.0M   0% /sys/fs/cgroup
/dev/sda1                  236M   86M  139M  39% /boot
tmpfs                      480M   56K  480M   1% /run/user/0
//10.11.1.136/Share    7.5G  998M  6.2G  14% /mnt/Share
root@kali:~/CTF# mount -t cifs -o vers=1.0,rw,dir_mode=0777,file_mode=0666,nounix //10.11.1.136/Share /mnt/Share/
```

## With hashes

CME checking with hashes, note the IP needs to come first

```text
root@kali:~/CTF/HTB/Silo# crackmapexec smb 10.10.10.82 -u Administrator -d SILO -H 'aad3b435b51404eeaad3b435b51404ee:9e730375b7cbcebf74ae46481e07b0c7'
SMB         10.10.10.82     445    SILO             [*] Windows Server 2012 R2 Standard 9600 x64 (name:SILO) (domain:SILO) (signing:False) (SMBv1:True)
SMB         10.10.10.82     445    SILO             [+] SILO\Administrator aad3b435b51404eeaad3b435b51404ee:9e730375b7cbcebf74ae46481e07b0c7 (Pwn3d!)
```

You may want to specify `--local-auth` so it doesn't authenticate with domain for hashes.

## rpcclient

```text
root@kali:~/CTF/HTB/Forest# rpcclient -U '' -N 10.10.10.161
rpcclient $> enumdomusers
user:[Administrator] rid:[0x1f4]
user:[Guest] rid:[0x1f5]
user:[krbtgt] rid:[0x1f6]
user:[DefaultAccount] rid:[0x1f7]
user:[$331000-VK4ADACQNUCA] rid:[0x463]
user:[SM_2c8eef0a09b545acb] rid:[0x464]
user:[SM_ca8c2ed5bdab4dc9b] rid:[0x465]
user:[SM_75a538d3025e4db9a] rid:[0x466]
user:[SM_681f53d4942840e18] rid:[0x467]
user:[SM_1b41c9286325456bb] rid:[0x468]
user:[SM_9b69f1b9d2cc45549] rid:[0x469]
user:[SM_7c96b981967141ebb] rid:[0x46a]
user:[SM_c75ee099d0a64c91b] rid:[0x46b]
user:[SM_1ffab36a2f5f479cb] rid:[0x46c]
user:[HealthMailboxc3d7722] rid:[0x46e]
user:[HealthMailboxfc9daad] rid:[0x46f]
user:[HealthMailboxc0a90c9] rid:[0x470]
user:[HealthMailbox670628e] rid:[0x471]
user:[HealthMailbox968e74d] rid:[0x472]
user:[HealthMailbox6ded678] rid:[0x473]
user:[HealthMailbox83d6781] rid:[0x474]
user:[HealthMailboxfd87238] rid:[0x475]
user:[HealthMailboxb01ac64] rid:[0x476]
user:[HealthMailbox7108a4e] rid:[0x477]
user:[HealthMailbox0659cc1] rid:[0x478]
user:[sebastien] rid:[0x479]
user:[lucinda] rid:[0x47a]
user:[svc-alfresco] rid:[0x47b]
user:[andy] rid:[0x47e]
user:[mark] rid:[0x47f]
user:[santi] rid:[0x480]
```

List path of shares

```text
rpcclient $> netshareenumall
netname: print$
        remark: Printer Drivers
        path:   C:\var\lib\samba\printers
        password:
netname: IPC$
        remark: IPC Service (break server (Samba, Ubuntu))
        path:   C:\tmp
        password:
```

